[TOC]

## 高斯分布检测算法

###  算法原理-句话说明

高斯分布检测算法的原理是：假设原始数据服从高斯分布，则落入分布中稀疏区域的点为异常点。

###  算法原理-文档

如果随机变量X服从均值为$\mu$，方差为$\sigma^2$的高斯分布，即$X～N(\mu,\sigma^2)$高斯分布,则高斯分布的密度函数为:

$f ( x ) = \frac { 1 } { \sqrt { 2 \pi } \delta } e ^ { - \frac { ( x - u ) ^ { 2 } } { 2 } }$

该分布图以$x=\mu$对称，$\sigma$决定了曲线的陡峭程度，如下图所示：
![img](./_image/高斯分布原理.png)



当样本特征服从高斯分布，我们可以用正态分布来对数据进行异常检测，流程可以分为三步：
（1）特征选择：符合高斯分布或能转换为高斯分布的特征；
（2）参数估计：计算数据分布的均值和方差；
（3）异常诊断：选定阈值$\epsilon$，把概率密度函数值小于某个阈值的点判定为异常，即$f(x)<\epsilon$的点诊断为异常点。$\epsilon$可以动态选择。例如经典的3-sigma方法是选取了累积概率密度函数约为99.7%时对应的数值，我们也可依据先验经验，确定N-sigma中N的取值值来确定阈值.不同的n对应着不同的正常值比例。
上界：$ UCL =\mu+N*\sigma$
下界：$ LCL =\mu-N*\sigma$

如下图：
![](./_image/高斯原理.png)



#### 参数说明



| arg_en_name | arg_zh_name | arg_index | arg_type | used_by   | properties                             | has_custom_performance | is_output_field | output_field_type | description |
| ----------- | ----------- | --------- | -------- | --------- | -------------------------------------- | ---------------------- | --------------- | ----------------- | ----------- |
| inputCol    | 输入列      | 0         | list     | developer | {"is_required": true, "list": "field"} | 0                      | 0               |                   | 输入列      |
| outputCol   | 输出列      | 1         | field    | developer | {"is_required": true}                  | 0                      | 1               | int               | 输出列      |

**标准差倍数**：取值范围为[1,n],	标准差倍数决定了正常值占总数的比例。标准差倍数越大，正常值占比越大，异常值占比越小。1倍，2倍，3倍标准差决定的正常值比例分别为68%，95%，99.7%。

**阈值**：设定应用阶段敏感度$\epsilon$为N-sigma中的n，则异常检测的上界为$\mu+\epsilon*\sigma$,下界为$\mu-\epsilon*\sigma$，中间线为均值$\mu$。当数据超过上下界范围时，就被检测为异常点。敏感度越小，上下界越靠近中线，正常值比例越低，异常值比例越高。

### 场景-交互式

如下图所示，滚动条的值是检测算法的N，对应异常分值的阈值，灰色区域是检测算法的正常区间，红色点是检测出的异常点。

向右拖动滚动条时，对应检测算法的N值变大，上下界更宽松，意味着更少的点被划分到异常区间。

可以看到右图-概率密度图中，异常区域变小，即更多的样本点落在了正常区间中。

使用：设定敏感度为n-sigma中的n，则异常检测的上界为$\mu+n*\sigma$,下界为$\mu-n*\sigma$，中间线为均值$\mu$。当数据超过上下界范围时，被检测为异常点。

向右拖动敏感度，敏感度n变大，上下界远离中线，异常点占比减少。


![高斯分布](./_image/高斯分布.png)





## 指数加权滑动平均(EWMA)检测算法

### 算法原理-句话说明

指数加权滑动平均(EWMA)检测算法原理是,先对原始时序进行指数平滑，得到下一个时刻的置信区间（也就是上下界），当下一个样本点超出置信区间，则判断为异常。

### 算法原理-文档

EWMA是指数加权滑动平均的简称，该方法也是异常检测的一个常用算法。原理是先对原始时序进行指数平滑，得到下一个时刻的置信区间（也就是上下界），当下一个样本点超出置信区间，则判断为异常。主要步骤为：

#### 参数说明
（1）**指数平滑**

对数据进行指数平滑处理，处理公式为：$EWMA_t=\lambda Y_t+(1-\lambda)EWMA_{t-1}$，其中：

- $EWMA_0$是历史数据的均值；
- $Y_t$是t时刻的观测值；
- n是数据总量；
- $\lambda$是一个参数，决定算法对历史数据的依赖程度， $0<\lambda<1$。$\lambda$越接近于1，历史数据的权重越小，当前时刻的权重越大。

（2）**异常检测**

EWMA 的估算方差为，$s^2_{ewma}=\frac{\lambda}{2-\lambda}s^2$,其中s为历史上历史数据的标准差；

则异常检测的上下界为：

上界：$UCL =EWMA_0+k*s_ {ewma}$

下界：$LCL =EWMA_0-k*s_{ewma}$

当数据超过上下界范围时，就被检测为异常点。其中$k$为常量，一般取值为3。$k$的取值决定了上下界的范围及异常值的比例。$k$越小，上下界越靠近中线，正常值比例越低，异常值比例越高。

下面举例说明计算过程:

**数据预览**：

```
52.0 47.0 53.0 49.3 50.1 47.0
51.0 50.1 51.2 50.5 49.6 47.6
49.9 51.3 47.8 51.2 52.6 52.4  53.6 52.1
```

**指数平滑**：

$EWMA_0$=50，选择$\lambda=0.3$,对数据进行指数平滑后，数据为：

```
50.00 50.60 49.52 50.56 50.18
50.16 49.21 49.75 49.85 50.26
50.33 50.11 49.36 49.52 50.05
49.38 49.92 50.73 51.23 51.94 51.99
```

**异常检测**：

$s^2_{ewma}=\frac{\lambda}{2-\lambda}s^2=\frac{0.3}{2-0.3}*2.0539$,，则$s_{ewma}=0.6039$,则上下界为：

$UCL=50+3(0.4201)(2.0539)=52.5884$

$LCL =50-3(0.4201)(2.0539)=47.4115$

效果图如下：

![ewma plot](./_image/ewma plot.png)

### 算法原理-可视化demo


![EWMA](./_image/EWMA_smooth.png)



![EWMA](./_images/EWMA异常检测.png)

###  训练-参数简化

衰减因子$\lambda$，其值介于0与1之间﹐表示EWMA对于历史量测值之权重系数。$\lambda$越接近于1，历史数据的权重越小，当前时刻的权重越大。

###  应用-敏感度

设定应用阶段敏感度$\epsilon$等于标准差倍数$k$，则异常检测的上界为$\mu+\epsilon*\sigma$,下界为$\mu-\epsilon*\sigma$，中间线$\mu=EWMA_0$,即历史数据的均值，$\sigma$为EWMA的标准差。当数据超过上下界范围时，就被检测为异常点。敏感度越小，上下界越靠近中线，正常值比例越低，异常值比例越高。





## 滑动平均(MA)检测算法

###  算法原理-句话说明

MA是滑动平均的简称，该方法也是异常检测的一个常用算法。原理是先对原始时序进行滑动平均，得到下一个时刻的置信区间（也就是上下界），当下一个样本点超出置信区间，则判断为异常。


### 算法原理-文档


MA是滑动平均的简称，该方法也是异常检测的一个常用算法。原理是先对原始时序进行滑动平均，得到下一个时刻的置信区间（也就是上下界），当下一个样本点超出置信区间，则判断为异常。

算法主要步骤为：

（1）**滑动平均**

计算方法：对于一个给定的数列，首先设定一个固定的滑动窗口长度w，然后分别计算第1项到第w项，第2项到第w+1项，第3项到第w+2项的平均值，依次类推。

（2）**异常检测**

在对原始数据进行滑动平均后，异常检测的上下界为：

上界：$UCL =\mu_0+\frac{k\sigma}{\sqrt{w}}$

下界：$LCL =\mu_0-\frac{k\sigma}{\sqrt{w}}$

当数据超过上下界范围时，就被检测为异常点。其中$\mu_0$为历史数据的均值,$\sigma$为历史数据的标准差，$w$为滑动窗口的长度，$k$为常量，一般取值为3。$k$的取值决定了上下界的范围及异常值的比例。$k$越小，上下界越靠近中线，正常值比例越低，异常值比例越高。


#### 参数说明

1. 滑动窗口长度$w$。$w$越大，噪声被去除的就越多，得到的信号就越平稳；但同时，信号的有用部分丢失原有特性的可能性就越大。
2. 设定应用阶段敏感度$\epsilon$等于标准差倍数$k$，则异常检测的上界为$\mu_0+\frac{k\sigma}{\sqrt{w}}$，下界为$\mu_0-\frac{k\sigma}{\sqrt{w}}$中间线$\mu=\mu_0$,即历史数据的均值，$\sigma$为MA的标准差，$w$为滑动窗口的长度。当数据超过上下界范围时，就被检测为异常点。敏感度越小，上下界越靠近中线，正常值比例越低，异常值比例越高。

### 算法原理-可视化demo

![MA](./_image/MA.png)

![滑动平均异常检测](./_image/滑动平均异常检测.png)

### 训练-参数简化

训练阶段参数简化：

滑动窗口长度$w$。$w$越大，噪声被去除的就越多，得到的信号就越平稳；但同时，信号的有用部分丢失原有特性的可能性就越大。

###  应用-敏感度

设定应用阶段敏感度$\epsilon$等于标准差倍数$k$，则异常检测的上界为$\mu_0+\frac{k\sigma}{\sqrt{w}}$，下界为$\mu_0-\frac{k\sigma}{\sqrt{w}}$中间线$\mu=\mu_0$,即历史数据的均值，$\sigma$为MA的标准差，$w$为滑动窗口的长度。当数据超过上下界范围时，就被检测为异常点。敏感度越小，上下界越靠近中线，正常值比例越低，异常值比例越高。



